{% extends "layout_accounting.html" %}
{% block title %}Record Expenses - {{ user.business_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="mb-4">Record Expenses</h1>

    <!-- Expense Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Record New Expense</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{{ url_for('expenses_route') }}">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="expense_date" class="form-label">Expense Date</label>
                            <input type="date" id="expense_date" name="expense_date" class="form-control" 
                                   value="{{ current_date.strftime('%Y-%m-%d') }}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="reference" class="form-label">Reference/Invoice Number</label>
                            <input type="text" id="reference" name="reference" class="form-control" 
                                   placeholder="e.g., INV-2024-001">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="expense_type" class="form-label">Expense Type</label>
                            <select id="expense_type" name="expense_type" class="form-control" required onchange="updateAccountOptions()">
                                <option value="" disabled selected>Select Expense Type</option>
                                <option value="processing_materials">Processing Materials (Wood, Salt, etc.)</option>
                                <option value="utilities">Utilities (Electricity, Water, Gas)</option>
                                <option value="labor">Labor Costs</option>
                                <option value="rent">Rent & Facilities</option>
                                <option value="transportation">Transportation</option>
                                <option value="equipment">Equipment & Maintenance</option>
                                <option value="other">Other Operating Expenses</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="account_code" class="form-label">Account Code</label>
                            <select id="account_code" name="account_code" class="form-control" required>
                                <option value="" disabled selected>Select Account</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <input type="text" id="description" name="description" class="form-control" 
                                   placeholder="e.g., Wood for smoking, Salt for processing" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount (â‚¦)</label>
                            <input type="number" id="amount" name="amount" class="form-control" 
                                   step="0.01" min="0" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="payment_method" class="form-label">Payment Method</label>
                            <select id="payment_method" name="payment_method" class="form-control" required>
                                <option value="cash" selected>Cash</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="check">Check</option>
                                <option value="credit_card">Credit Card</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="vendor" class="form-label">Vendor/Supplier (Optional)</label>
                            <input type="text" id="vendor" name="vendor" class="form-control" 
                                   placeholder="e.g., Local Wood Supplier">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea id="notes" name="notes" class="form-control" rows="2" 
                              placeholder="Additional notes about this expense"></textarea>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Record Expense
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recent Expenses -->
    <div class="card">
        <div class="card-header">
            <h5>Recent Expenses</h5>
        </div>
        <div class="card-body">
            {% if expenses %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Account</th>
                            <th>Payment Method</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in expenses %}
                        <tr>
                            <td>{{ expense['expense_date'].strftime('%Y-%m-%d') if expense['expense_date'] else 'N/A' }}</td>
                            <td><span class="badge bg-info">{{ expense['expense_type'].replace('_', ' ').title() }}</span></td>
                            <td>{{ expense['description'] }}</td>
                            <td>{{ expense['amount']|currency }}</td>
                            <td>{{ expense['account_code'] }}</td>
                            <td>{{ expense['payment_method'].replace('_', ' ').title() }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <p class="text-muted">No expenses recorded yet. Start by recording your first expense above.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Account code mapping based on expense type
const accountMapping = {
    'processing_materials': [
        { code: '5400', name: 'Raw Materials - Processing' },
        { code: '5410', name: 'Wood & Fuel' },
        { code: '5420', name: 'Salt & Seasonings' }
    ],
    'utilities': [
        { code: '5500', name: 'Utilities Expense' },
        { code: '5510', name: 'Electricity' },
        { code: '5520', name: 'Water' },
        { code: '5530', name: 'Gas' }
    ],
    'labor': [
        { code: '5600', name: 'Labor Expense' },
        { code: '5610', name: 'Wages & Salaries' },
        { code: '5620', name: 'Overtime' }
    ],
    'rent': [
        { code: '5700', name: 'Rent Expense' },
        { code: '5710', name: 'Facility Rent' },
        { code: '5720', name: 'Equipment Rent' }
    ],
    'transportation': [
        { code: '5800', name: 'Transportation Expense' },
        { code: '5810', name: 'Vehicle Fuel' },
        { code: '5820', name: 'Delivery Costs' }
    ],
    'equipment': [
        { code: '5900', name: 'Equipment & Maintenance' },
        { code: '5910', name: 'Equipment Purchase' },
        { code: '5920', name: 'Repairs & Maintenance' }
    ],
    'other': [
        { code: '5990', name: 'Other Operating Expenses' },
        { code: '5991', name: 'Miscellaneous' }
    ]
};

function updateAccountOptions() {
    const expenseType = document.getElementById('expense_type').value;
    const accountSelect = document.getElementById('account_code');
    
    // Clear existing options
    accountSelect.innerHTML = '<option value="" disabled selected>Select Account</option>';
    
    if (expenseType && accountMapping[expenseType]) {
        accountMapping[expenseType].forEach(account => {
            const option = document.createElement('option');
            option.value = account.code;
            option.textContent = `${account.code} - ${account.name}`;
            accountSelect.appendChild(option);
        });
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateAccountOptions();
});
</script>
{% endblock %}