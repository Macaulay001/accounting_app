{% extends "layout_accounting.html" %}
{% block content %}
<h1 class="mb-4">Inventory Batch Management</h1>

<!-- Add New Batch Form -->
<div class="card mb-4">
    <div class="card-header">
        <h5>Add New Inventory Batch</h5>
    </div>
    <div class="card-body">
        <form method="post" action="{{ url_for('inventory_batches_route') }}">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="vendor_id" class="form-label">Vendor</label>
                        <select id="vendor_id" name="vendor_id" class="form-select" required>
                            <option value="" disabled selected>Select Vendor</option>
                            {% for vendor in vendors %}
                            <option value="{{ vendor['id'] }}">{{ vendor['name'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="raw_material_type" class="form-label">Raw Material Type</label>
                        <select id="raw_material_type" name="raw_material_type" class="form-select">
                            <option value="cow_skin" selected>Cow Skin</option>
                            <option value="goat_skin">Goat Skin</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="total_ile" class="form-label">Number of Ile Packs</label>
                        <input type="number" class="form-control" id="total_ile" name="total_ile" min="1" value="1" required onchange="generateIlePiecesInputs()">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="total_pieces_display" class="form-label">Total Pieces</label>
                        <input type="text" class="form-control" id="total_pieces_display" readonly value="100">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="purchase_cost" class="form-label">Total Cost (â‚¦)</label>
                        <input type="number" class="form-control" id="purchase_cost" name="purchase_cost" step="0.01" min="0" required>
                    </div>
                </div>
            </div>
            
            <!-- Dynamic ILE Pieces Inputs -->
            <div class="row" id="ile_pieces_container">
                <div class="col-12">
                    <div class="mb-3">
                        <label class="form-label">Pieces per ILE Pack</label>
                        <div class="row" id="ile_pieces_inputs">
                            <div class="col-md-3 mb-2">
                                <label for="ile_1_pieces" class="form-label small">ILE Pack 1</label>
                                <input type="number" class="form-control" id="ile_1_pieces" name="ile_pieces[]" min="1" value="100" required onchange="calculateTotalPieces()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select id="payment_method" name="payment_method" class="form-select" required>
                            <option value="accounts_payable" selected>On Credit (Accounts Payable)</option>
                            <option value="cash">Cash Payment</option>
                            <option value="bank_transfer">Bank Transfer</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="reference" class="form-label">Reference/Invoice Number</label>
                        <input type="text" class="form-control" id="reference" name="reference" placeholder="e.g., INV-2024-001">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="purchase_date" class="form-label">Purchase Date</label>
                        <input type="date" class="form-control" id="purchase_date" name="purchase_date" value="{{ current_date.strftime('%Y-%m-%d') }}" required>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Create Batch</button>
        </form>
    </div>
</div>


<!-- Existing Batches -->
<div class="card">
    <div class="card-header">
        <h5>Existing Inventory Batches</h5>
    </div>
    <div class="card-body">
        {% if batches %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Batch ID</th>
                        <th>Vendor</th>
                        <th>Material Type</th>
                        <th>Ile Packs</th>
                        <th>Total Pieces</th>
                        <th>Remaining</th>
                        <th>Purchase Cost</th>
                        <th>Payment Method</th>
                        <th>Purchase Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for batch in batches %}
                    <tr>
                        <td><code>{{ batch['id'][:8] }}...</code></td>
                        <td>{{ batch['vendor_name'] }}</td>
                        <td>{{ batch['raw_material_type'].replace('_', ' ').title() }}</td>
                        <td>{{ batch['total_ile'] }}</td>
                        <td>{{ batch['total_pieces'] }}</td>
                        <td>
                            <span class="badge bg-{% if batch['current_pieces'] > 0 %}success{% else %}danger{% endif %}">
                                {{ batch['current_pieces'] }}
                            </span>
                        </td>
                        <td>{{ batch['purchase_cost']|currency }}</td>
                        <td>
                            <span class="badge bg-{% if batch.get('payment_method') == 'accounts_payable' %}warning{% elif batch.get('payment_method') == 'cash' %}success{% elif batch.get('payment_method') == 'bank_transfer' %}info{% else %}secondary{% endif %}">
                                {{ batch.get('payment_method', 'accounts_payable').replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td>{{ batch['purchase_date'].strftime('%Y-%m-%d') if batch['purchase_date'] else 'N/A' }}</td>
                        <td>
                            <span class="badge bg-{% if batch['status'] == 'raw_material' %}secondary{% elif batch['status'] == 'in_production' %}warning{% elif batch['status'] == 'finished_goods' %}info{% elif batch['status'] == 'sold' %}success{% else %}light{% endif %}">
                                {{ batch['status'].replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('batch_details_route', batch_id=batch['id']) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <a href="{{ url_for('edit_batch', batch_id=batch['id']) }}" class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteBatch('{{ batch['id'] }}', '{{ batch['vendor_name'] }} - {{ batch['raw_material_type'].replace('_', ' ').title() }}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <p class="text-muted">No inventory batches found. Create your first batch above.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function generateIlePiecesInputs() {
    const totalIle = parseInt(document.getElementById('total_ile').value) || 1;
    const container = document.getElementById('ile_pieces_inputs');
    
    // Clear existing inputs
    container.innerHTML = '';
    
    // Generate inputs for each ILE pack
    for (let i = 1; i <= totalIle; i++) {
        const colDiv = document.createElement('div');
        colDiv.className = 'col-md-3 mb-2';
        
        colDiv.innerHTML = `
            <label for="ile_${i}_pieces" class="form-label small">ILE Pack ${i}</label>
            <input type="number" class="form-control" id="ile_${i}_pieces" name="ile_pieces[]" min="1" value="100" required onchange="calculateTotalPieces()">
        `;
        
        container.appendChild(colDiv);
    }
    
    // Calculate total pieces after generating inputs
    calculateTotalPieces();
}

function calculateTotalPieces() {
    const totalIle = parseInt(document.getElementById('total_ile').value) || 0;
    let totalPieces = 0;
    
    // Sum up pieces from all ILE pack inputs
    for (let i = 1; i <= totalIle; i++) {
        const input = document.getElementById(`ile_${i}_pieces`);
        if (input) {
            totalPieces += parseInt(input.value) || 0;
        }
    }
    
    document.getElementById('total_pieces_display').value = totalPieces;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    generateIlePiecesInputs();
});

function deleteBatch(batchId, batchName) {
    if (confirm(`Are you sure you want to delete this inventory batch?\n\n${batchName}\n\nThis action cannot be undone and will also delete any associated journal entries.`)) {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete-batch/${batchId}`;
        
        // Add CSRF token if needed
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

</script>
{% endblock %}
