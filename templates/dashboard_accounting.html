{% extends "layout_accounting.html" %}
{% block title %}Dashboard - {{ user.business_name }}{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-tachometer-alt me-3"></i>
                    Welcome to {{ user.business_name }}
                </h1>
                <p class="mb-0 fs-5">
                    <i class="fas fa-phone me-2"></i>{{ user.phone_number }} | 
                    <i class="fas fa-calendar me-2"></i>{{ current_date.strftime('%B %d, %Y') }}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-light" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button type="button" class="btn btn-light" onclick="exportData()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Financial Overview Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="dashboard-widget">
            <div class="d-flex align-items-center">
                <div class="widget-icon revenue me-3">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div>
                    <div class="widget-value amount-positive">{{ total_revenue|currency }}</div>
                    <div class="widget-label">Total Revenue</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="dashboard-widget">
            <div class="d-flex align-items-center">
                <div class="widget-icon expense me-3">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div>
                    <div class="widget-value amount-negative">{{ payables|currency }}</div>
                    <div class="widget-label">Outstanding Payables</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="dashboard-widget">
            <div class="d-flex align-items-center">
                <div class="widget-icon asset me-3">
                    <i class="fas fa-wallet"></i>
                </div>
                <div>
                    <div class="widget-value amount-neutral">{{ cash_balance|currency }}</div>
                    <div class="widget-label">Cash on Hand</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="dashboard-widget">
            <div class="d-flex align-items-center">
                <div class="widget-icon asset me-3">
                    <i class="fas fa-boxes"></i>
                </div>
                <div>
                    <div class="widget-value amount-neutral">{{ inventory_value|currency }}</div>
                    <div class="widget-label">Inventory Value</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="dashboard-widget">
            <div class="d-flex align-items-center">
                <div class="widget-icon profit me-3">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <div class="widget-value amount-positive">{{ (total_revenue - (payables + inventory_value))|currency }}</div>
                    <div class="widget-label">Net Worth</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="dashboard-widget">
            <div class="d-flex align-items-center">
                <div class="widget-icon receivables me-3">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
                <div>
                    <div class="widget-value amount-neutral">{{ receivables|currency }}</div>
                    <div class="widget-label">Accounts Receivable</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="dashboard-widget">
            <div class="d-flex align-items-center">
                <div class="widget-icon inventory me-3">
                    <i class="fas fa-warehouse"></i>
                </div>
                <div>
                    <div class="widget-value amount-neutral">{{ inventory_value|currency }}</div>
                    <div class="widget-label">Inventory Value</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="dashboard-widget">
            <div class="d-flex align-items-center">
                <div class="widget-icon payables me-3">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div>
                    <div class="widget-value amount-negative">{{ payables|currency }}</div>
                    <div class="widget-label">Accounts Payable</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card-accounting">
            <div class="card-header-accounting">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('sales_route') }}" class="btn btn-accounting btn-accounting-success w-100">
                            <i class="fas fa-plus me-2"></i>Record Sale
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('inventory_batches_route') }}" class="btn btn-accounting btn-accounting-primary w-100">
                            <i class="fas fa-layer-group me-2"></i>Inventory Batches
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('production_route') }}" class="btn btn-accounting btn-accounting-warning w-100">
                            <i class="fas fa-cogs me-2"></i>Process Materials
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('expenses_route') }}" class="btn btn-accounting btn-accounting-danger w-100">
                            <i class="fas fa-receipt me-2"></i>Record Expense
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('vendor_payments_route') }}" class="btn btn-accounting btn-accounting-info w-100">
                            <i class="fas fa-credit-card me-2"></i>Vendor Payments
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                        <a href="{{ url_for('reports_route') }}" class="btn btn-accounting btn-accounting-secondary w-100">
                            <i class="fas fa-chart-bar me-2"></i>Business Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accounting Insights & Alerts -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card-accounting">
            <div class="card-header-accounting">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Accounting Alerts
                </h5>
            </div>
            <div class="card-body">
                <div class="alert-list">
                    {% if payables > 0 %}
                    <div class="alert alert-warning d-flex align-items-center mb-2">
                        <i class="fas fa-credit-card me-2"></i>
                        <div>
                            <strong>Outstanding Payables:</strong> {{ payables|currency }} owed to vendors
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if receivables > 0 %}
                    <div class="alert alert-info d-flex align-items-center mb-2">
                        <i class="fas fa-hand-holding-usd me-2"></i>
                        <div>
                            <strong>Accounts Receivable:</strong> {{ receivables|currency }} expected from customers
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if inventory_value > 0 %}
                    <div class="alert alert-success d-flex align-items-center mb-2">
                        <i class="fas fa-warehouse me-2"></i>
                        <div>
                            <strong>Inventory Value:</strong> {{ inventory_value|currency }} in stock
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if payables == 0 and receivables == 0 and inventory_value == 0 %}
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p class="text-muted mb-0">No outstanding accounting items</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card-accounting">
            <div class="card-header-accounting">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Financial Health
                </h5>
            </div>
            <div class="card-body">
                <div class="financial-health">
                    <div class="health-metric">
                        <div class="metric-label">Cash Position</div>
                        <div class="metric-value {{ 'text-success' if cash_balance > 0 else 'text-danger' }}">
                            {{ cash_balance|currency }}
                        </div>
                        <div class="metric-status">
                            {% if cash_balance > 0 %}
                                <i class="fas fa-check-circle text-success"></i> Healthy
                            {% else %}
                                <i class="fas fa-exclamation-circle text-danger"></i> Low Cash
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="health-metric">
                        <div class="metric-label">Net Worth</div>
                        <div class="metric-value {{ 'text-success' if (total_revenue - (payables + inventory_value)) > 0 else 'text-warning' }}">
                            {{ (total_revenue - (payables + inventory_value))|currency }}
                        </div>
                        <div class="metric-status">
                            {% if (total_revenue - (payables + inventory_value)) > 0 %}
                                <i class="fas fa-arrow-up text-success"></i> Positive
                            {% else %}
                                <i class="fas fa-arrow-down text-warning"></i> Monitor
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="health-metric">
                        <div class="metric-label">Revenue</div>
                        <div class="metric-value text-primary">
                            {{ total_revenue|currency }}
                        </div>
                        <div class="metric-status">
                            <i class="fas fa-chart-line text-primary"></i> Track Performance
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card-accounting">
            <div class="card-header-accounting d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Transactions
                </h5>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="reloadTransactions()" id="reload-transactions-btn">
                    <i class="fas fa-sync-alt me-1" id="reload-icon"></i>Reload
                </button>
            </div>
            <div class="card-body">
                {% if recent_entries %}
                <div class="table-responsive">
                    <table class="table table-accounting">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in recent_entries %}
                            <tr>
                                <td>{{ entry['date'].strftime('%Y-%m-%d') if entry['date'] else 'N/A' }}</td>
                                <td>
                                    <span class="badge bg-{% if entry['type'] == 'sale' %}success{% elif entry['type'] == 'purchase' %}primary{% elif entry['type'] == 'production' %}warning{% else %}info{% endif %}">
                                        {{ entry['type'].title() }}
                                    </span>
                                </td>
                                <td>{{ entry['description'] or 'N/A' }}</td>
                                <td class="text-accounting">
                                    {{ entry['amount']|currency }}
                                </td>
                                <td>
                                    <span class="badge bg-{% if entry['status'] == 'posted' %}success{% else %}warning{% endif %}">
                                        {{ entry['status'].title() }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No recent transactions found. Start by recording your first sale or purchase.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Trigger onboarding tour for new users
{% if show_tour %}
document.addEventListener('DOMContentLoaded', function() {
    // Small delay to ensure page is fully loaded
    setTimeout(function() {
        if (window.startOnboardingTour) {
            window.startOnboardingTour();
        }
    }, 1000);
});
{% endif %}
</script>
<script>
function refreshDashboard() {
    location.reload();
}

function exportData() {
    // TODO: Implement data export functionality
    alert('Export functionality coming soon!');
}

function reloadTransactions() {
    const reloadBtn = document.getElementById('reload-transactions-btn');
    const reloadIcon = document.getElementById('reload-icon');
    
    // Disable button and show loading state
    reloadBtn.disabled = true;
    reloadIcon.classList.add('fa-spin');
    
    // Reload the page to get fresh transaction data
    setTimeout(() => {
        location.reload();
    }, 500); // Small delay to show the loading state
}


// Auto-refresh dashboard every 5 minutes
setInterval(function() {
    // Only refresh if no modal is open
    if (!document.querySelector('.modal.show')) {
        location.reload();
    }
}, 300000); // 5 minutes
</script>
{% endblock %}
